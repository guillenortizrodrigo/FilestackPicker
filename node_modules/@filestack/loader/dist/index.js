"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var MODULE_PREFIX = 'fs-loader-';
var globalHolder = {};
var initializeGlobalNamespace = function () {
    var holder;
    // if there is no window obj use nodejs global lib variable
    if (typeof window === 'undefined') {
        holder = globalHolder;
    }
    else {
        holder = window;
    }
    // @ts-ignore
    var namespace = holder.filestackInternals;
    if (!namespace) {
        namespace = {
            modules: {},
        };
        holder.filestackInternals = namespace;
    }
    if (!namespace.modules) {
        namespace.modules = {};
    }
    return namespace;
};
var filestackInternals = initializeGlobalNamespace();
var modules = filestackInternals && filestackInternals.modules;
/**
 * Remove listeners (browser compatible)
 *
 * @param node
 * @param func
 * @param name
 */
var removeListener = function (node, func, name) {
    if (node.detachEvent) {
        node.detachEvent('onreadystatechange', func);
    }
    else {
        node.removeEventListener(name, func, false);
    }
};
/**
 * Load multiple modules
 *
 * @param {*} modules
 */
exports.loadModules = function (modulesList) { return Promise.all(modulesList.map(function (_a) {
    var id = _a.id, url = _a.url;
    return exports.loadModule(id, url);
})).then(function (res) {
    var toReturn = {};
    res.forEach(function (mod, idx) {
        var el = modulesList[idx];
        toReturn[el.id] = mod;
    });
    return toReturn;
}); };
/**
 * Load single module from url with given id
 *
 * @param {*} id - module id
 * @param {*} url
 */
exports.loadModule = function (id, url) {
    if (typeof window === 'undefined') {
        return Promise.reject(new Error('Load module is working only on browser env'));
    }
    if (!id) {
        throw new Error('Module id is required');
    }
    id = MODULE_PREFIX + id;
    var moduleDefinition = modules[id];
    if (!moduleDefinition) {
        modules[id] = {};
        moduleDefinition = modules[id];
    }
    if (moduleDefinition.instance) {
        return Promise.resolve(moduleDefinition.instance);
    }
    if (moduleDefinition.promise) {
        return moduleDefinition.promise;
    }
    return moduleDefinition.promise = new Promise(function (resolve, reject) {
        var readyStateChange = function (evt) {
            if (evt.type === 'load' || (/^(complete|loaded)$/.test((evt.currentTarget || evt.srcElement).readyState))) {
                var node = evt.currentTarget || evt.srcElement;
                removeListener(node, readyStateChange, 'load');
                removeListener(node, reject, 'error');
                // slow dow checking if module is loaded to ensure that script that  register module is called
                setTimeout(function () { return resolve(modules[id] ? modules[id].instance : undefined); }, 10);
            }
        };
        var script = document.createElement('script');
        script.id = id;
        // @ts-ignore fix for IE
        if (script.attachEvent && !(script.attachEvent.toString && script.attachEvent.toString().indexOf('[native code') < 0)) {
            // @ts-ignore
            script.attachEvent('onreadystatechange', readyStateChange);
        }
        else {
            script.addEventListener('load', readyStateChange, false);
            script.addEventListener('onerror', reject, false);
        }
        script.setAttribute('crossorigin', 'anonymous');
        script.setAttribute('charset', 'utf-8');
        script.setAttribute('async', 'true');
        script.src = url;
        document.body.appendChild(script);
    });
};
/**
 * Register that module is ready
 *
 * @param {string} id
 * @param {any} instance
 * @param {any} metadata - additional module metadata like version
 */
exports.registerModule = function (id, instance, metadata) {
    // loader not working on nodejs envs
    if (typeof window === 'undefined') {
        return;
    }
    if (!id) {
        throw new Error('Module id is required');
    }
    if (!modules) {
        throw new Error('Loader is not initialized');
    }
    id = MODULE_PREFIX + id;
    if (modules[id]) {
        modules[id] = { instance: instance, metadata: metadata };
    }
};
/**
 * Load external css from given url
 *
 * @param {*} url
 */
exports.loadCss = function (url) {
    var alreadyAddedThisTag = document.querySelector("link[href=\"" + url + "\"]");
    if (alreadyAddedThisTag !== null) {
        return Promise.resolve();
    }
    return new Promise(function (resolve) {
        var head = document.getElementsByTagName('head')[0];
        var link = document.createElement('link');
        var loaded = function () {
            resolve();
            link.removeEventListener('load', loaded);
        };
        link.rel = 'stylesheet';
        link.href = url;
        link.addEventListener('load', loaded);
        head.appendChild(link);
    });
};
/**
 * Enum just for unify filestack module names
 */
var FILESTACK_MODULES;
(function (FILESTACK_MODULES) {
    FILESTACK_MODULES["FILESTACK_SDK"] = "filestack-sdk";
    FILESTACK_MODULES["TRANSFORMS_UI"] = "transforms-ui";
    FILESTACK_MODULES["PICKER"] = "picker";
})(FILESTACK_MODULES = exports.FILESTACK_MODULES || (exports.FILESTACK_MODULES = {}));
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9saWIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFNLGFBQWEsR0FBRyxZQUFZLENBQUM7QUFDbkMsSUFBTSxZQUFZLEdBQVEsRUFBRSxDQUFDO0FBZTdCLElBQU0seUJBQXlCLEdBQUc7SUFDaEMsSUFBSSxNQUFVLENBQUM7SUFFZiwyREFBMkQ7SUFDM0QsSUFBSSxPQUFPLE1BQU0sS0FBSyxXQUFXLEVBQUU7UUFDakMsTUFBTSxHQUFHLFlBQVksQ0FBQztLQUN2QjtTQUFNO1FBQ0wsTUFBTSxHQUFHLE1BQU0sQ0FBQTtLQUNoQjtJQUVELGFBQWE7SUFDYixJQUFJLFNBQVMsR0FBYyxNQUFNLENBQUMsa0JBQWtCLENBQUM7SUFFckQsSUFBSSxDQUFDLFNBQVMsRUFBRTtRQUNkLFNBQVMsR0FBRztZQUNWLE9BQU8sRUFBRSxFQUFFO1NBQ1osQ0FBQztRQUVGLE1BQU0sQ0FBQyxrQkFBa0IsR0FBRyxTQUFTLENBQUM7S0FDdkM7SUFFRCxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRTtRQUN0QixTQUFTLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztLQUN4QjtJQUVELE9BQU8sU0FBUyxDQUFDO0FBQ25CLENBQUMsQ0FBQztBQUVGLElBQU0sa0JBQWtCLEdBQUcseUJBQXlCLEVBQUUsQ0FBQztBQUN2RCxJQUFNLE9BQU8sR0FBRyxrQkFBa0IsSUFBSSxrQkFBa0IsQ0FBQyxPQUFPLENBQUM7QUFFakU7Ozs7OztHQU1HO0FBQ0gsSUFBTSxjQUFjLEdBQUcsVUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUk7SUFDdEMsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1FBQ3BCLElBQUksQ0FBQyxXQUFXLENBQUMsb0JBQW9CLEVBQUUsSUFBSSxDQUFDLENBQUM7S0FDOUM7U0FBTTtRQUNMLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUUsSUFBSSxF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Qy9CLG9EQUErQixDQUFBO0lBQy9CLHNDQUFpQixDQUFBO0FBQ25CLENBQUMsRUFKVyxpQkFBaUIsR0FBakIseUJBQWlCLEtBQWpCLHlCQUFpQixRQUk1QjtBQUFBLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBNT0RVTEVfUFJFRklYID0gJ2ZzLWxvYWRlci0nO1xuY29uc3QgZ2xvYmFsSG9sZGVyOiBhbnkgPSB7fTtcblxuZXhwb3J0IHR5cGUgTW9kdWxlRGVmID0ge1xuICBwcm9taXNlPzogUHJvbWlzZTxhbnk+XG4gIHJlc29sdmVQcm9taXNlPzogYW55O1xuICBpbnN0YW5jZT86IGFueTtcbiAgbWV0YWRhdGE/OiBhbnk7XG59XG5cbmV4cG9ydCB0eXBlIE5hbWVzcGFjZSA9IHtcbiAgICBtb2R1bGVzOiB7XG4gICAgIFtrZXk6IHN0cmluZ106IE1vZHVsZURlZlxuICAgIH1cbn07XG5cbmNvbnN0IGluaXRpYWxpemVHbG9iYWxOYW1lc3BhY2UgPSAoKSA9PiB7XG4gIGxldCBob2xkZXI6YW55O1xuXG4gIC8vIGlmIHRoZXJlIGlzIG5vIHdpbmRvdyBvYmogdXNlIG5vZGVqcyBnbG9iYWwgbGliIHZhcmlhYmxlXG4gIGlmICh0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJykge1xuICAgIGhvbGRlciA9IGdsb2JhbEhvbGRlcjtcbiAgfSBlbHNlIHtcbiAgICBob2xkZXIgPSB3aW5kb3dcbiAgfVxuXG4gIC8vIEB0cy1pZ25vcmVcbiAgbGV0IG5hbWVzcGFjZTogTmFtZXNwYWNlID0gaG9sZGVyLmZpbGVzdGFja0ludGVybmFscztcblxuICBpZiAoIW5hbWVzcGFjZSkge1xuICAgIG5hbWVzcGFjZSA9IHtcbiAgICAgIG1vZHVsZXM6IHt9LFxuICAgIH07XG5cbiAgICBob2xkZXIuZmlsZXN0YWNrSW50ZXJuYWxzID0gbmFtZXNwYWNlO1xuICB9XG5cbiAgaWYgKCFuYW1lc3BhY2UubW9kdWxlcykge1xuICAgIG5hbWVzcGFjZS5tb2R1bGVzID0ge307XG4gIH1cbiAgXG4gIHJldHVybiBuYW1lc3BhY2U7XG59O1xuXG5jb25zdCBmaWxlc3RhY2tJbnRlcm5hbHMgPSBpbml0aWFsaXplR2xvYmFsTmFtZXNwYWNlKCk7XG5jb25zdCBtb2R1bGVzID0gZmlsZXN0YWNrSW50ZXJuYWxzICYmIGZpbGVzdGFja0ludGVybmFscy5tb2R1bGVzO1xuXG4vKipcbiAqIFJlbW92ZSBsaXN0ZW5lcnMgKGJyb3dzZXIgY29tcGF0aWJsZSlcbiAqIFxuICogQHBhcmFtIG5vZGUgXG4gKiBAcGFyYW0gZnVuYyBcbiAqIEBwYXJhbSBuYW1lIFxuICovXG5jb25zdCByZW1vdmVMaXN0ZW5lciA9IChub2RlLCBmdW5jLCBuYW1lLCApID0+IHtcbiAgaWYgKG5vZGUuZGV0YWNoRXZlbnQpIHtcbiAgICBub2RlLmRldGFjaEV2ZW50KCdvbnJlYWR5c3RhdGVjaGFuZ2UnLCBmdW5jKTtcbiAgfSBlbHNlIHtcbiAgICBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIobmFtZSwgZnVuYywgZmFsc2UpO1xuICB9XG59XG5cbi8qKlxuICogTG9hZCBtdWx0aXBsZSBtb2R1bGVzXG4gKiBcbiAqIEBwYXJhbSB7Kn0gbW9kdWxlcyBcbiAqL1xuZXhwb3J0IGNvbnN0IGxvYWRNb2R1bGVzID0gKG1vZHVsZXNMaXN0KSA9PiBQcm9taXNlLmFsbChtb2R1bGVzTGlzdC5tYXAoKHsgaWQsIHVybCB9KSA9PiBsb2FkTW9kdWxlKGlkLCB1cmwpKSkudGhlbigocmVzKSA9PiB7XG4gIGNvbnN0IHRvUmV0dXJuID0ge307XG5cbiAgcmVzLmZvckVhY2goKG1vZCwgaWR4KSA9PiB7XG4gICAgY29uc3QgZWwgPSBtb2R1bGVzTGlzdFtpZHhdO1xuICAgIHRvUmV0dXJuW2VsLmlkXSA9IG1vZDtcbiAgfSk7XG5cbiAgcmV0dXJuIHRvUmV0dXJuO1xufSk7XG5cbi8qKlxuICogTG9hZCBzaW5nbGUgbW9kdWxlIGZyb20gdXJsIHdpdGggZ2l2ZW4gaWRcbiAqXG4gKiBAcGFyYW0geyp9IGlkIC0gbW9kdWxlIGlkIFxuICogQHBhcmFtIHsqfSB1cmxcbiAqL1xuZXhwb3J0IGNvbnN0IGxvYWRNb2R1bGUgPSAoaWQ6IHN0cmluZywgdXJsOiBzdHJpbmcpID0+IHtcbiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcignTG9hZCBtb2R1bGUgaXMgd29ya2luZyBvbmx5IG9uIGJyb3dzZXIgZW52JykpO1xuICB9XG5cbiAgaWYgKCFpZCkge1xuICAgIHRocm93IG5ldyBFcnJvcignTW9kdWxlIGlkIGlzIHJlcXVpcmVkJylcbiAgfVxuXG4gIGlkID0gIE1PRFVMRV9QUkVGSVggKyBpZDtcbiAgbGV0IG1vZHVsZURlZmluaXRpb24gPSBtb2R1bGVzW2lkXTtcblxuICBpZiAoIW1vZHVsZURlZmluaXRpb24pIHtcbiAgICBtb2R1bGVzW2lkXSA9IHt9O1xuICAgIG1vZHVsZURlZmluaXRpb24gPSBtb2R1bGVzW2lkXTtcbiAgfVxuXG4gIGlmIChtb2R1bGVEZWZpbml0aW9uLmluc3RhbmNlKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShtb2R1bGVEZWZpbml0aW9uLmluc3RhbmNlKTtcbiAgfVxuXG4gIGlmIChtb2R1bGVEZWZpbml0aW9uLnByb21pc2UpIHtcbiAgICByZXR1cm4gbW9kdWxlRGVmaW5pdGlvbi5wcm9taXNlO1xuICB9XG5cbiAgcmV0dXJuIG1vZHVsZURlZmluaXRpb24ucHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjb25zdCByZWFkeVN0YXRlQ2hhbmdlID0gKGV2dDogYW55KSA9PiB7XG4gICAgICBpZiAoZXZ0LnR5cGUgPT09ICdsb2FkJyB8fCAoL14oY29tcGxldGV8bG9hZGVkKSQvLnRlc3QoKGV2dC5jdXJyZW50VGFyZ2V0IHx8IGV2dC5zcmNFbGVtZW50KS5yZWFkeVN0YXRlKSkpIHtcbiAgICAgICAgY29uc3Qgbm9kZSA9ICBldnQuY3VycmVudFRhcmdldCB8fCBldnQuc3JjRWxlbWVudDtcblxuICAgICAgICByZW1vdmVMaXN0ZW5lcihub2RlLCByZWFkeVN0YXRlQ2hhbmdlLCAnbG9hZCcpO1xuICAgICAgICByZW1vdmVMaXN0ZW5lcihub2RlLCByZWplY3QsICdlcnJvcicpO1xuXG4gICAgICAgIC8vIHNsb3cgZG93IGNoZWNraW5nIGlmIG1vZHVsZSBpcyBsb2FkZWQgdG8gZW5zdXJlIHRoYXQgc2NyaXB0IHRoYXQgIHJlZ2lzdGVyIG1vZHVsZSBpcyBjYWxsZWRcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiByZXNvbHZlKG1vZHVsZXNbaWRdID8gbW9kdWxlc1tpZF0uaW5zdGFuY2UgOiB1bmRlZmluZWQpLCAxMCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3Qgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7XG4gICAgXG4gICAgc2NyaXB0LmlkID0gaWQ7XG5cbiAgICAvLyBAdHMtaWdub3JlIGZpeCBmb3IgSUVcbiAgICBpZiAoc2NyaXB0LmF0dGFjaEV2ZW50ICYmICEoc2NyaXB0LmF0dGFjaEV2ZW50LnRvU3RyaW5nICYmIHNjcmlwdC5hdHRhY2hFdmVudC50b1N0cmluZygpLmluZGV4T2YoJ1tuYXRpdmUgY29kZScpIDwgMCkpIHtcbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIHNjcmlwdC5hdHRhY2hFdmVudCgnb25yZWFkeXN0YXRlY2hhbmdlJywgcmVhZHlTdGF0ZUNoYW5nZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHNjcmlwdC5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgcmVhZHlTdGF0ZUNoYW5nZSwgZmFsc2UpO1xuICAgICAgc2NyaXB0LmFkZEV2ZW50TGlzdGVuZXIoJ29uZXJyb3InLCByZWplY3QsIGZhbHNlKTtcbiAgICB9XG5cbiAgICBzY3JpcHQuc2V0QXR0cmlidXRlKCdjcm9zc29yaWdpbicsICdhbm9ueW1vdXMnKTtcbiAgICBzY3JpcHQuc2V0QXR0cmlidXRlKCdjaGFyc2V0JywgJ3V0Zi04Jyk7XG4gICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgnYXN5bmMnLCAndHJ1ZScpO1xuXG4gICAgc2NyaXB0LnNyYyA9IHVybDtcblxuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTtcbiAgfSk7XG59O1xuXG4vKipcbiAqIFJlZ2lzdGVyIHRoYXQgbW9kdWxlIGlzIHJlYWR5XG4gKiBcbiAqIEBwYXJhbSB7c3RyaW5nfSBpZCBcbiAqIEBwYXJhbSB7YW55fSBpbnN0YW5jZSBcbiAqIEBwYXJhbSB7YW55fSBtZXRhZGF0YSAtIGFkZGl0aW9uYWwgbW9kdWxlIG1ldGFkYXRhIGxpa2UgdmVyc2lvblxuICovXG5leHBvcnQgY29uc3QgcmVnaXN0ZXJNb2R1bGUgPSAoaWQ6IHN0cmluZywgaW5zdGFuY2U6IGFueSwgbWV0YWRhdGE/OiBhbnkpID0+IHtcbiAgLy8gbG9hZGVyIG5vdCB3b3JraW5nIG9uIG5vZGVqcyBlbnZzXG4gIGlmICh0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJykge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmICghaWQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ01vZHVsZSBpZCBpcyByZXF1aXJlZCcpXG4gIH1cblxuICBpZiAoIW1vZHVsZXMpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0xvYWRlciBpcyBub3QgaW5pdGlhbGl6ZWQnKVxuICB9XG5cbiAgaWQgPSBNT0RVTEVfUFJFRklYICsgaWQ7XG5cbiAgaWYgKG1vZHVsZXNbaWRdKSB7XG4gICAgbW9kdWxlc1tpZF0gPSB7IGluc3RhbmNlLCBtZXRhZGF0YSB9XG4gIH1cbn07XG5cbi8qKlxuICogTG9hZCBleHRlcm5hbCBjc3MgZnJvbSBnaXZlbiB1cmxcbiAqIFxuICogQHBhcmFtIHsqfSB1cmwgXG4gKi9cbmV4cG9ydCBjb25zdCBsb2FkQ3NzID0gKHVybCkgPT4ge1xuICBjb25zdCBhbHJlYWR5QWRkZWRUaGlzVGFnID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgbGlua1tocmVmPVwiJHt1cmx9XCJdYCk7XG4gIGlmIChhbHJlYWR5QWRkZWRUaGlzVGFnICE9PSBudWxsKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9XG5cbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgY29uc3QgaGVhZCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdoZWFkJylbMF07XG4gICAgY29uc3QgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpbmsnKTtcblxuICAgIGNvbnN0IGxvYWRlZCA9ICgpID0+IHtcbiAgICAgIHJlc29sdmUoKTtcbiAgICAgIGxpbmsucmVtb3ZlRXZlbnRMaXN0ZW5lcignbG9hZCcsIGxvYWRlZCk7XG4gICAgfTtcblxuICAgIGxpbmsucmVsID0gJ3N0eWxlc2hlZXQnO1xuICAgIGxpbmsuaHJlZiA9IHVybDtcbiAgICBsaW5rLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBsb2FkZWQpO1xuICAgIGhlYWQuYXBwZW5kQ2hpbGQobGluayk7XG4gIH0pO1xufTtcblxuLyoqXG4gKiBFbnVtIGp1c3QgZm9yIHVuaWZ5IGZpbGVzdGFjayBtb2R1bGUgbmFtZXNcbiAqL1xuZXhwb3J0IGVudW0gRklMRVNUQUNLX01PRFVMRVMge1xuICBGSUxFU1RBQ0tfU0RLID0gJ2ZpbGVzdGFjay1zZGsnLFxuICBUUkFOU0ZPUk1TX1VJID0gJ3RyYW5zZm9ybXMtdWknLFxuICBQSUNLRVIgPSAncGlja2VyJyxcbn07XG4iXX0=