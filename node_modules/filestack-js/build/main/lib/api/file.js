"use strict";
/*
 * Copyright (c) 2018 by Filestack.
 * Some rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var filelink_1 = require("./../filelink");
var utils_1 = require("../utils");
var filestack_error_1 = require("./../../filestack_error");
var schema_1 = require("./../../schema");
var request_1 = require("../request");
/**
 * Remove given file
 *
 * @private
 * @param session
 * @param handle
 * @param security
 */
exports.remove = function (session, handle, skipStorage, security) {
    if (!handle || typeof handle !== 'string') {
        throw new filestack_error_1.FilestackError('A valid Filestack handle is required for remove');
    }
    if (!(session.policy && session.signature) && (!security || !(security.policy && security.signature))) {
        throw new filestack_error_1.FilestackError('Security policy and signature are required for remove');
    }
    var fileApiUrl = session.urls.fileApiUrl;
    var baseURL = fileApiUrl + "/" + handle;
    var options = {
        key: session.apikey,
        policy: (security && security.policy) || session.policy,
        signature: (security && security.signature) || session.signature,
    };
    if (skipStorage) {
        options.skip_storage = true;
    }
    return request_1.FsRequest.delete(baseURL, {
        filestackHeaders: false,
        params: utils_1.removeEmpty(options),
    });
};
/**
 * Returns file metadata
 *
 * @private
 * @param session
 * @param handle
 * @param opts
 * @param security
 */
exports.metadata = function (session, handle, opts, security) {
    if (!handle || typeof handle !== 'string') {
        throw new filestack_error_1.FilestackError('A valid Filestack handle is required for metadata');
    }
    var validateRes = schema_1.getValidator(schema_1.MetadataParamsSchema)(opts);
    if (validateRes.errors.length) {
        throw new filestack_error_1.FilestackError("Invalid metadata params", validateRes.errors);
    }
    var options = tslib_1.__assign({}, opts);
    options.source_url = options.sourceUrl; // source_url is snake_case
    options.policy = (security && security.policy) || session.policy;
    options.signature = (security && security.signature) || session.signature;
    var baseURL = session.urls.fileApiUrl + "/" + handle + "/metadata";
    return new Promise(function (resolve, reject) {
        request_1.FsRequest.get(baseURL, { params: utils_1.removeEmpty(options), filestackHeaders: false })
            .then(function (res) { return resolve(tslib_1.__assign(tslib_1.__assign({}, res.data), { handle: handle })); })
            .catch(reject);
    });
};
/**
 * Download file to blob or buffer format
 *
 * @param session
 * @param handle
 */
exports.download = function (session, handle, security) {
    var fl = new filelink_1.Filelink(handle, session.apikey);
    var policy = (security && security.policy) || session.policy;
    var signature = (security && security.signature) || session.signature;
    if (policy && signature) {
        fl.security({ signature: signature, policy: policy });
    }
    return request_1.FsRequest.dispatch(fl.toString(), { method: request_1.FsHttpMethod.GET, blobResponse: true });
};
/**
 * Returns file information
 *
 * @private
 * @deprecated
 * @param session
 * @param handle
 * @param options
 * @param security
 */
exports.retrieve = function (session, handle, options, security) {
    if (options === void 0) { options = {}; }
    if (!handle || handle.length === 0 || typeof handle !== 'string') {
        throw new filestack_error_1.FilestackError('File handle is required');
    }
    console.info('Retrieve method is deprecated and it will be removed. Please use metadata or download');
    var validateRes = schema_1.getValidator(schema_1.RetrieveParamsSchema)(options);
    if (validateRes.errors.length) {
        throw new filestack_error_1.FilestackError("Invalid retrieve params", validateRes.errors);
    }
    var requestOptions = tslib_1.__assign({}, options);
    requestOptions.key = session.apikey;
    requestOptions.policy = (security && security.policy) || session.policy;
    requestOptions.signature = (security && security.signature) || session.signature;
    var method = request_1.FsHttpMethod.GET;
    if (requestOptions.head) {
        method = request_1.FsHttpMethod.HEAD;
        delete requestOptions.head;
    }
    var extension;
    if (requestOptions.extension && requestOptions.extension.length) {
        extension = requestOptions.extension;
        delete requestOptions.extension;
    }
    var metadata;
    if (requestOptions.metadata) {
        if (method === request_1.FsHttpMethod.HEAD) {
            throw new filestack_error_1.FilestackError('Head and metadata options cannot be used together');
        }
        metadata = requestOptions.metadata;
        delete requestOptions.metadata;
    }
    var baseURL = session.urls.fileApiUrl + "/" + handle + (extension ? "+" + extension : '') + (metadata ? '/metadata' : '');
    return new Promise(function (resolve, reject) {
        request_1.FsRequest.dispatch(baseURL, {
            method: method,
            filestackHeaders: false,
            params: utils_1.removeEmpty(requestOptions),
        })
            .then(function (res) { return resolve(method === request_1.FsHttpMethod.HEAD ? res.headers : res.data); })
            .catch(reject);
    });
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvYXBpL2ZpbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7Ozs7R0FlRzs7O0FBR0gsMENBQXlDO0FBQ3pDLGtDQUF1QztBQUV2QywyREFBeUQ7QUFDekQseUNBQTBGO0FBQzFGLHNDQUFxRDtBQUVyRDs7Ozs7OztHQU9HO0FBQ1UsUUFBQSxNQUFNLEdBQUcsVUFBQyxPQUFnQixFQUFFLE1BQWUsRUFBRSxXQUFxQixFQUFFLFFBQW1CO0lBQ2xHLElBQUksQ0FBQyxNQUFNLElBQUksT0FBTyxNQUFNLEtBQUssUUFBUSxFQUFFO1FBQ3pDLE1BQU0sSUFBSSxnQ0FBYyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7S0FDN0U7SUFFRCxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxJQUFJLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxJQUFJLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFO1FBQ3JHLE1BQU0sSUFBSSxnQ0FBYyxDQUFDLHVEQUF1RCxDQUFDLENBQUM7S0FDbkY7SUFFRCxJQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztJQUMzQyxJQUFNLE9BQU8sR0FBTSxVQUFVLFNBQUksTUFBUSxDQUFDO0lBQzFDLElBQU0sT0FBTyxHQUFRO1FBQ25CLEdBQUcsRUFBRSxPQUFPLENBQUMsTUFBTTtRQUNuQixNQUFNLEVBQUUsQ0FBQyxRQUFRLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxNQUFNO1FBQ3ZELFNBQVMsRUFBRSxDQUFDLFFBQVEsSUFBSSxRQUFRLENBQUMsU0FBUyxDQUFDLElBQUksT0FBTyxDQUFDLFNBQVM7S0FDakUsQ0FBQztJQUVGLElBQUksV0FBVyxFQUFFO1FBQ2YsT0FBTyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7S0FDN0I7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UUFBUSxDQUFDO0lBQ2IsSUFBSSxjQUFjLENBQUMsUUFBUSxFQUFFO1FBQzNCLElBQUksTUFBTSxLQUFLLHNCQUFZLENBQUMsSUFBSSxFQUFFO1lBQ2hDLE1BQU0sSUFBSSxnQ0FBYyxDQUFDLG1EQUFtRCxDQUFDLENBQUM7U0FDL0U7UUFFRCxRQUFRLEdBQUcsY0FBYyxDQUFDLFFBQVEsQ0FBQztRQUNuQyxPQUFPLGNBQWMsQ0FBQyxRQUFRLENBQUM7S0FDaEM7SUFFRCxJQUFNLE9BQU8sR0FBTSxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsU0FBSSxNQUFRLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLE1BQUksU0FBVyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUU1SCxPQUFPLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTyxFQUFFLE1BQU07UUFDakMsbUJBQVMsQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFO1lBQzFCLE1BQU0sUUFBQTtZQUNOLGdCQUFnQixFQUFFLEtBQUs7WUFDdkIsTUFBTSxFQUFFLG1CQUFXLENBQUMsY0FBYyxDQUFDO1NBQ3BDLENBQUM7YUFDQyxJQUFJLENBQUMsVUFBQSxHQUFHLElBQUksT0FBQSxPQUFPLENBQUMsTUFBTSxLQUFLLHNCQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQTlELENBQThELENBQUM7YUFDM0UsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ25CLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDIiwiZmlsZSI6ImxpYi9hcGkvZmlsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTggYnkgRmlsZXN0YWNrLlxuICogU29tZSByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IFNlY3VyaXR5LCBTZXNzaW9uIH0gZnJvbSAnLi4vY2xpZW50JztcbmltcG9ydCB7IEZpbGVsaW5rIH0gZnJvbSAnLi8uLi9maWxlbGluayc7XG5pbXBvcnQgeyByZW1vdmVFbXB0eSB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IEZzUmVzcG9uc2UgfSBmcm9tICcuLy4uL3JlcXVlc3QvdHlwZXMnO1xuaW1wb3J0IHsgRmlsZXN0YWNrRXJyb3IgfSBmcm9tICcuLy4uLy4uL2ZpbGVzdGFja19lcnJvcic7XG5pbXBvcnQgeyBnZXRWYWxpZGF0b3IsIE1ldGFkYXRhUGFyYW1zU2NoZW1hLCBSZXRyaWV2ZVBhcmFtc1NjaGVtYSB9IGZyb20gJy4vLi4vLi4vc2NoZW1hJztcbmltcG9ydCB7IEZzUmVxdWVzdCwgRnNIdHRwTWV0aG9kIH0gZnJvbSAnLi4vcmVxdWVzdCc7XG5cbi8qKlxuICogUmVtb3ZlIGdpdmVuIGZpbGVcbiAqXG4gKiBAcHJpdmF0ZVxuICogQHBhcmFtIHNlc3Npb25cbiAqIEBwYXJhbSBoYW5kbGVcbiAqIEBwYXJhbSBzZWN1cml0eVxuICovXG5leHBvcnQgY29uc3QgcmVtb3ZlID0gKHNlc3Npb246IFNlc3Npb24sIGhhbmRsZT86IHN0cmluZywgc2tpcFN0b3JhZ2U/OiBib29sZWFuLCBzZWN1cml0eT86IFNlY3VyaXR5KTogUHJvbWlzZTxhbnk+ID0+IHtcbiAgaWYgKCFoYW5kbGUgfHwgdHlwZW9mIGhhbmRsZSAhPT0gJ3N0cmluZycpIHtcbiAgICB0aHJvdyBuZXcgRmlsZXN0YWNrRXJyb3IoJ0EgdmFsaWQgRmlsZXN0YWNrIGhhbmRsZSBpcyByZXF1aXJlZCBmb3IgcmVtb3ZlJyk7XG4gIH1cblxuICBpZiAoIShzZXNzaW9uLnBvbGljeSAmJiBzZXNzaW9uLnNpZ25hdHVyZSkgJiYgKCFzZWN1cml0eSB8fCAhKHNlY3VyaXR5LnBvbGljeSAmJiBzZWN1cml0eS5zaWduYXR1cmUpKSkge1xuICAgIHRocm93IG5ldyBGaWxlc3RhY2tFcnJvcignU2VjdXJpdHkgcG9saWN5IGFuZCBzaWduYXR1cmUgYXJlIHJlcXVpcmVkIGZvciByZW1vdmUnKTtcbiAgfVxuXG4gIGNvbnN0IGZpbGVBcGlVcmwgPSBzZXNzaW9uLnVybHMuZmlsZUFwaVVybDtcbiAgY29uc3QgYmFzZVVSTCA9IGAke2ZpbGVBcGlVcmx9LyR7aGFuZGxlfWA7XG4gIGNvbnN0IG9wdGlvbnM6IGFueSA9IHtcbiAgICBrZXk6IHNlc3Npb24uYXBpa2V5LFxuICAgIHBvbGljeTogKHNlY3VyaXR5ICYmIHNlY3VyaXR5LnBvbGljeSkgfHwgc2Vzc2lvbi5wb2xpY3ksXG4gICAgc2lnbmF0dXJlOiAoc2VjdXJpdHkgJiYgc2VjdXJpdHkuc2lnbmF0dXJlKSB8fCBzZXNzaW9uLnNpZ25hdHVyZSxcbiAgfTtcblxuICBpZiAoc2tpcFN0b3JhZ2UpIHtcbiAgICBvcHRpb25zLnNraXBfc3RvcmFnZSA9IHRydWU7XG4gIH1cblxuICByZXR1cm4gRnNSZXF1ZXN0LmRlbGV0ZShiYXNlVVJMLCB7XG4gICAgZmlsZXN0YWNrSGVhZGVyczogZmFsc2UsXG4gICAgcGFyYW1zOiByZW1vdmVFbXB0eShvcHRpb25zKSxcbiAgfSk7XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIE1ldGFkYXRhT3B0aW9ucyB7XG4gIHNpemU/OiBib29sZWFuO1xuICBtaW1ldHlwZT86IGJvb2xlYW47XG4gIGZpbGVuYW1lPzogYm9vbGVhbjtcbiAgd2lkdGg/OiBib29sZWFuO1xuICBoZWlnaHQ/OiBib29sZWFuO1xuICB1cGxvYWRlZD86IGJvb2xlYW47XG4gIHdyaXRlYWJsZT86IGJvb2xlYW47XG4gIGNsb3VkPzogYm9vbGVhbjtcbiAgc291cmNlVXJsPzogYm9vbGVhbjtcbiAgbWQ1PzogYm9vbGVhbjtcbiAgc2hhMT86IGJvb2xlYW47XG4gIHNoYTIyND86IGJvb2xlYW47XG4gIHNoYTI1Nj86IGJvb2xlYW47XG4gIHNoYTM4ND86IGJvb2xlYW47XG4gIHNoYTUxMj86IGJvb2xlYW47XG4gIGxvY2F0aW9uPzogYm9vbGVhbjtcbiAgcGF0aD86IGJvb2xlYW47XG4gIGNvbnRhaW5lcj86IGJvb2xlYW47XG4gIGV4aWY/OiBib29sZWFuO1xufVxuXG4vKipcbiAqIFJldHVybnMgZmlsZSBtZXRhZGF0YVxuICpcbiAqIEBwcml2YXRlXG4gKiBAcGFyYW0gc2Vzc2lvblxuICogQHBhcmFtIGhhbmRsZVxuICogQHBhcmFtIG9wdHNcbiAqIEBwYXJhbSBzZWN1cml0eVxuICovXG5leHBvcnQgY29uc3QgbWV0YWRhdGEgPSAoc2Vzc2lvbjogU2Vzc2lvbiwgaGFuZGxlPzogc3RyaW5nLCBvcHRzPzogTWV0YWRhdGFPcHRpb25zLCBzZWN1cml0eT86IFNlY3VyaXR5KTogUHJvbWlzZTxhbnk+ID0+IHtcbiAgaWYgKCFoYW5kbGUgfHwgdHlwZW9mIGhhbmRsZSAhPT0gJ3N0cmluZycpIHtcbiAgICB0aHJvdyBuZXcgRmlsZXN0YWNrRXJyb3IoJ0EgdmFsaWQgRmlsZXN0YWNrIGhhbmRsZSBpcyByZXF1aXJlZCBmb3IgbWV0YWRhdGEnKTtcbiAgfVxuXG4gIGNvbnN0IHZhbGlkYXRlUmVzID0gZ2V0VmFsaWRhdG9yKE1ldGFkYXRhUGFyYW1zU2NoZW1hKShvcHRzKTtcblxuICBpZiAodmFsaWRhdGVSZXMuZXJyb3JzLmxlbmd0aCkge1xuICAgIHRocm93IG5ldyBGaWxlc3RhY2tFcnJvcihgSW52YWxpZCBtZXRhZGF0YSBwYXJhbXNgLCB2YWxpZGF0ZVJlcy5lcnJvcnMpO1xuICB9XG5cbiAgY29uc3Qgb3B0aW9uczogYW55ID0geyAuLi5vcHRzIH07XG4gIG9wdGlvbnMuc291cmNlX3VybCA9IG9wdGlvbnMuc291cmNlVXJsOyAvLyBzb3VyY2VfdXJsIGlzIHNuYWtlX2Nhc2VcbiAgb3B0aW9ucy5wb2xpY3kgPSAoc2VjdXJpdHkgJiYgc2VjdXJpdHkucG9saWN5KSB8fCBzZXNzaW9uLnBvbGljeTtcbiAgb3B0aW9ucy5zaWduYXR1cmUgPSAoc2VjdXJpdHkgJiYgc2VjdXJpdHkuc2lnbmF0dXJlKSB8fCBzZXNzaW9uLnNpZ25hdHVyZTtcblxuICBjb25zdCBiYXNlVVJMID0gYCR7c2Vzc2lvbi51cmxzLmZpbGVBcGlVcmx9LyR7aGFuZGxlfS9tZXRhZGF0YWA7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgRnNSZXF1ZXN0LmdldChiYXNlVVJMLCB7IHBhcmFtczogcmVtb3ZlRW1wdHkob3B0aW9ucyksIGZpbGVzdGFja0hlYWRlcnM6IGZhbHNlIH0pXG4gICAgICAudGhlbihyZXMgPT4gcmVzb2x2ZSh7IC4uLnJlcy5kYXRhLCBoYW5kbGUgfSkpXG4gICAgICAuY2F0Y2gocmVqZWN0KTtcbiAgfSk7XG59O1xuXG4vKipcbiAqIERvd25sb2FkIGZpbGUgdG8gYmxvYiBvciBidWZmZXIgZm9ybWF0XG4gKlxuICogQHBhcmFtIHNlc3Npb25cbiAqIEBwYXJhbSBoYW5kbGVcbiAqL1xuZXhwb3J0IGNvbnN0IGRvd25sb2FkID0gKHNlc3Npb246IFNlc3Npb24sIGhhbmRsZTogc3RyaW5nLCAgc2VjdXJpdHk/OiBTZWN1cml0eSk6IFByb21pc2U8RnNSZXNwb25zZT4gPT4ge1xuICBjb25zdCBmbCA9IG5ldyBGaWxlbGluayhoYW5kbGUsIHNlc3Npb24uYXBpa2V5KTtcblxuICBjb25zdCBwb2xpY3kgPSAoc2VjdXJpdHkgJiYgc2VjdXJpdHkucG9saWN5KSB8fCBzZXNzaW9uLnBvbGljeTtcbiAgY29uc3Qgc2lnbmF0dXJlID0gKHNlY3VyaXR5ICYmIHNlY3VyaXR5LnNpZ25hdHVyZSkgfHwgc2Vzc2lvbi5zaWduYXR1cmU7XG5cbiAgaWYgKHBvbGljeSAmJiBzaWduYXR1cmUpIHtcbiAgICBmbC5zZWN1cml0eSh7IHNpZ25hdHVyZSwgcG9saWN5IH0pO1xuICB9XG5cbiAgcmV0dXJuIEZzUmVxdWVzdC5kaXNwYXRjaChmbC50b1N0cmluZygpLCB7IG1ldGhvZDogRnNIdHRwTWV0aG9kLkdFVCwgYmxvYlJlc3BvbnNlOiB0cnVlIH0pO1xufTtcblxuZXhwb3J0IGludGVyZmFjZSBSZXRyaWV2ZU9wdGlvbnMge1xuICBtZXRhZGF0YT86IGJvb2xlYW47XG4gIGhlYWQ/OiBib29sZWFuO1xuICBkbD86IGJvb2xlYW47XG4gIGV4dGVuc2lvbj86IHN0cmluZztcbiAgY2FjaGU/OiBib29sZWFuO1xufVxuXG4vKipcbiAqIFJldHVybnMgZmlsZSBpbmZvcm1hdGlvblxuICpcbiAqIEBwcml2YXRlXG4gKiBAZGVwcmVjYXRlZFxuICogQHBhcmFtIHNlc3Npb25cbiAqIEBwYXJhbSBoYW5kbGVcbiAqIEBwYXJhbSBvcHRpb25zXG4gKiBAcGFyYW0gc2VjdXJpdHlcbiAqL1xuZXhwb3J0IGNvbnN0IHJldHJpZXZlID0gKHNlc3Npb246IFNlc3Npb24sIGhhbmRsZTogc3RyaW5nLCBvcHRpb25zOiBSZXRyaWV2ZU9wdGlvbnMgPSB7fSwgc2VjdXJpdHk/OiBTZWN1cml0eSk6IFByb21pc2U8T2JqZWN0IHwgQmxvYj4gPT4ge1xuICBpZiAoIWhhbmRsZSB8fCBoYW5kbGUubGVuZ3RoID09PSAwIHx8IHR5cGVvZiBoYW5kbGUgIT09ICdzdHJpbmcnKSB7XG4gICAgdGhyb3cgbmV3IEZpbGVzdGFja0Vycm9yKCdGaWxlIGhhbmRsZSBpcyByZXF1aXJlZCcpO1xuICB9XG5cbiAgY29uc29sZS5pbmZvKCdSZXRyaWV2ZSBtZXRob2QgaXMgZGVwcmVjYXRlZCBhbmQgaXQgd2lsbCBiZSByZW1vdmVkLiBQbGVhc2UgdXNlIG1ldGFkYXRhIG9yIGRvd25sb2FkJyk7XG5cbiAgY29uc3QgdmFsaWRhdGVSZXMgPSBnZXRWYWxpZGF0b3IoUmV0cmlldmVQYXJhbXNTY2hlbWEpKG9wdGlvbnMpO1xuXG4gIGlmICh2YWxpZGF0ZVJlcy5lcnJvcnMubGVuZ3RoKSB7XG4gICAgdGhyb3cgbmV3IEZpbGVzdGFja0Vycm9yKGBJbnZhbGlkIHJldHJpZXZlIHBhcmFtc2AsIHZhbGlkYXRlUmVzLmVycm9ycyk7XG4gIH1cblxuICBjb25zdCByZXF1ZXN0T3B0aW9uczogYW55ID0geyAuLi5vcHRpb25zIH07XG4gIHJlcXVlc3RPcHRpb25zLmtleSA9IHNlc3Npb24uYXBpa2V5O1xuICByZXF1ZXN0T3B0aW9ucy5wb2xpY3kgPSAoc2VjdXJpdHkgJiYgc2VjdXJpdHkucG9saWN5KSB8fCBzZXNzaW9uLnBvbGljeTtcbiAgcmVxdWVzdE9wdGlvbnMuc2lnbmF0dXJlID0gKHNlY3VyaXR5ICYmIHNlY3VyaXR5LnNpZ25hdHVyZSkgfHwgc2Vzc2lvbi5zaWduYXR1cmU7XG5cbiAgbGV0IG1ldGhvZDogRnNIdHRwTWV0aG9kID0gRnNIdHRwTWV0aG9kLkdFVDtcblxuICBpZiAocmVxdWVzdE9wdGlvbnMuaGVhZCkge1xuICAgIG1ldGhvZCA9IEZzSHR0cE1ldGhvZC5IRUFEO1xuICAgIGRlbGV0ZSByZXF1ZXN0T3B0aW9ucy5oZWFkO1xuICB9XG5cbiAgbGV0IGV4dGVuc2lvbjtcblxuICBpZiAocmVxdWVzdE9wdGlvbnMuZXh0ZW5zaW9uICYmIHJlcXVlc3RPcHRpb25zLmV4dGVuc2lvbi5sZW5ndGgpIHtcbiAgICBleHRlbnNpb24gPSByZXF1ZXN0T3B0aW9ucy5leHRlbnNpb247XG4gICAgZGVsZXRlIHJlcXVlc3RPcHRpb25zLmV4dGVuc2lvbjtcbiAgfVxuXG4gIGxldCBtZXRhZGF0YTtcbiAgaWYgKHJlcXVlc3RPcHRpb25zLm1ldGFkYXRhKSB7XG4gICAgaWYgKG1ldGhvZCA9PT0gRnNIdHRwTWV0aG9kLkhFQUQpIHtcbiAgICAgIHRocm93IG5ldyBGaWxlc3RhY2tFcnJvcignSGVhZCBhbmQgbWV0YWRhdGEgb3B0aW9ucyBjYW5ub3QgYmUgdXNlZCB0b2dldGhlcicpO1xuICAgIH1cblxuICAgIG1ldGFkYXRhID0gcmVxdWVzdE9wdGlvbnMubWV0YWRhdGE7XG4gICAgZGVsZXRlIHJlcXVlc3RPcHRpb25zLm1ldGFkYXRhO1xuICB9XG5cbiAgY29uc3QgYmFzZVVSTCA9IGAke3Nlc3Npb24udXJscy5maWxlQXBpVXJsfS8ke2hhbmRsZX1gICsgKGV4dGVuc2lvbiA/IGArJHtleHRlbnNpb259YCA6ICcnKSArIChtZXRhZGF0YSA/ICcvbWV0YWRhdGEnIDogJycpO1xuXG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgRnNSZXF1ZXN0LmRpc3BhdGNoKGJhc2VVUkwsIHtcbiAgICAgIG1ldGhvZCxcbiAgICAgIGZpbGVzdGFja0hlYWRlcnM6IGZhbHNlLFxuICAgICAgcGFyYW1zOiByZW1vdmVFbXB0eShyZXF1ZXN0T3B0aW9ucyksXG4gICAgfSlcbiAgICAgIC50aGVuKHJlcyA9PiByZXNvbHZlKG1ldGhvZCA9PT0gRnNIdHRwTWV0aG9kLkhFQUQgPyByZXMuaGVhZGVycyA6IHJlcy5kYXRhKSlcbiAgICAgIC5jYXRjaChyZWplY3QpO1xuICB9KTtcbn07XG4iXX0=
